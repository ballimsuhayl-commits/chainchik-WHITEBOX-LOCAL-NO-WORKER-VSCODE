services:
  db:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: chainchik
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  api:
    build:
      context: .
      dockerfile: docker/api.Dockerfile
    env_file: [.env]
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/chainchik
    depends_on: [db]
    ports: ["4000:4000"]
    volumes:
      - uploads_data:/data/uploads

  worker:
    build:
      context: .
      dockerfile: docker/worker.Dockerfile
    env_file: [.env]
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/chainchik
    depends_on: [db]

  web:
    build:
      context: .
      dockerfile: docker/web.Dockerfile
    env_file: [.env]
    environment:
      NEXT_PUBLIC_API_URL: http://api:4000
    depends_on: [api]
    ports: ["3000:3000"]


backup:
  build:
    context: .
    dockerfile: docker/backup.Dockerfile
  env_file: [.env]
  environment:
    DATABASE_URL: postgresql://postgres:postgres@db:5432/chainchik
    BACKUP_DIR: /backups
    BACKUP_INTERVAL_HOURS: 24
  volumes:
    - backups_data:/backups
  depends_on: [db]


minio:
  image: minio/minio:RELEASE.2025-01-20T14-49-07Z
  command: server /data --console-address ":9001"
  environment:
    MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioadmin}
    MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-minioadmin}
  volumes:
    - minio_data:/data
  ports:
    - "9000:9000"
    - "9001:9001"


minio-init:
  image: minio/mc:RELEASE.2025-01-17T23-25-50Z
  depends_on:
    - minio
  entrypoint: >
    /bin/sh -c "
    echo 'Waiting for MinIO...';
    until mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin}; do
      sleep 2;
    done;
    echo 'Creating bucket if missing...';
    mc mb -p local/${S3_BUCKET:-chainchik} || true;
    echo 'Setting public read policy (static image hosting)...';
    mc anonymous set download local/${S3_BUCKET:-chainchik} || true;
    echo 'MinIO init complete.';
    "

volumes:
  db_data:
  uploads_data:
  backups_data:
